<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="it.memelabs.smartnebula.lmm.persistence.main.mapper.LotExMapper">

    <resultMap id="BaseResultMap" type="it.memelabs.smartnebula.lmm.persistence.main.dto.LotEx"
               extends="it.memelabs.smartnebula.lmm.persistence.main.mapper.LotMapper.BaseResultMap">
        <association property="jobOrder" javaType="it.memelabs.smartnebula.lmm.persistence.main.dto.JobOrder"
                     resultMap="it.memelabs.smartnebula.lmm.persistence.main.mapper.JobOrderMapper.BaseResultMap"
                     columnPrefix="j_">
        </association>
        <association property="assignedCompany" javaType="it.memelabs.smartnebula.lmm.persistence.main.dto.Company"
                     resultMap="it.memelabs.smartnebula.lmm.persistence.main.mapper.CompanyMapper.BaseResultMap"
                     columnPrefix="c_">
        </association>
        <association property="worksManager" javaType="it.memelabs.smartnebula.lmm.persistence.main.dto.Person"
                     resultMap="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.BaseResultMap"
                     columnPrefix="wm_">
        </association>
        <association property="dtl" javaType="it.memelabs.smartnebula.lmm.persistence.main.dto.Person"
                     resultMap="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.BaseResultMap"
                     columnPrefix="dtl_">
        </association>
    </resultMap>
    
    <sql id="Example_Where_Clause">        
        <trim prefix="WHERE" prefixOverrides="and |or ">
            <trim prefix="and (" suffix=")" prefixOverrides="WHERE">
                <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.LotMapper.Example_Where_Clause"/>                    
            </trim>
            <if test="filterText != null">
                and (
                lower(description) like lower(#{filterText})
                or lower(code) like lower(#{filterText})                
                )
            </if>
        </trim>
    </sql>

	<sql id="Min_Alias_Column_List">
		${tableAlias}description AS ${fieldAlias}description, 
		${tableAlias}code AS ${fieldAlias}code 
	</sql>

    <select id="countByExample" parameterType="it.memelabs.smartnebula.lmm.persistence.main.dto.LotExExample"
            resultType="java.lang.Integer">
        select count(*) from lot 
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>


    <resultMap id="LocationsResultMap" type="it.memelabs.smartnebula.lmm.persistence.main.dto.LotEx" extends="BaseResultMap">

        <collection property="locations" javaType="ArrayList" column="id"
                    ofType="it.memelabs.smartnebula.lmm.persistence.main.dto.PostalAddressEx"
                    select="it.memelabs.smartnebula.lmm.persistence.main.mapper.PostalAddressExMapper.selectByLotId" />
    </resultMap>

    <select id="selectByPrimaryKeyEx" parameterType="java.lang.Long" resultMap="LocationsResultMap">
        select
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.LotMapper.Alias_Column_List">
            <property name="tableAlias" value="l."/>
            <property name="fieldAlias" value=""/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.JobOrderMapper.Alias_Column_List">
            <property name="tableAlias" value="j."/>
            <property name="fieldAlias" value="j_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.CompanyMapper.Alias_Column_List">
            <property name="tableAlias" value="c."/>
            <property name="fieldAlias" value="c_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.Alias_Column_List">
            <property name="tableAlias" value="wm."/>
            <property name="fieldAlias" value="wm_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.Alias_Column_List">
            <property name="tableAlias" value="dtl."/>
            <property name="fieldAlias" value="dtl_"/>
        </include>
        from lot l
        left join job_order j on l.job_order_id = j.id
        left join company c on l.assigned_company_id = c.id
        left join person wm on l.works_manager_id = wm.id
        left join person dtl on l.dtl_id = dtl.id
        where l.id = #{id,jdbcType=BIGINT}
    </select>

    <select id="selectByExampleWithRowbounds"
            parameterType="it.memelabs.smartnebula.lmm.persistence.main.dto.LotExExample" resultMap="BaseResultMap">
        select * from (
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.LotMapper.Alias_Column_List">
            <property name="tableAlias" value="l."/>
            <property name="fieldAlias" value=""/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.JobOrderMapper.Alias_Column_List">
            <property name="tableAlias" value="j."/>
            <property name="fieldAlias" value="j_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.CompanyMapper.Alias_Column_List">
            <property name="tableAlias" value="c."/>
            <property name="fieldAlias" value="c_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.Alias_Column_List">
            <property name="tableAlias" value="wm."/>
            <property name="fieldAlias" value="wm_"/>
        </include>
        ,
        <include refid="it.memelabs.smartnebula.lmm.persistence.main.mapper.PersonMapper.Alias_Column_List">
            <property name="tableAlias" value="dtl."/>
            <property name="fieldAlias" value="dtl_"/>
        </include>

        from lot l
        left join job_order j on l.job_order_id = j.id
        left join company c on l.assigned_company_id = c.id
        left join person wm on l.works_manager_id = wm.id
        left join person dtl on l.dtl_id = dtl.id
        ) t
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>

</mapper>
