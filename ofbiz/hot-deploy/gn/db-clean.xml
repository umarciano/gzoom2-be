<?xml version="1.0" encoding="UTF-8"?>

<project name="Clean Postgresql db" default="clean-postgresql-db" basedir=".">
    <property file="local.properties"/>
    <property name="db.name" value="ofbiz"/>
    <property name="db.driver" value="${local.db.driver}"/>
    <property name="db.url" value="${local.db.url}"/>
    <property name="db.password" value="${local.db.password}"/>
    <property name="db.user" value="${local.db.user}"/>
    <property name="tmp.file" value="./tables.sql"/>
    <property name="ofbiz.path" value="${local.ofbiz.path}"/>

    <target name="clean-postgresql-db" description="Drop all tables">


        <!-- <fail message="No postgresql driver, not cleaning postgresql db">
             <condition>
                 <not>
                     <available type="file" file="${local.db.driverjar}" filepath="framework/entity/lib/jdbc/"/>
                 </not>
             </condition>
         </fail>-->
        <delete file="${tmp.file}"/>

        <echo message="Resetting ${db.name}"/>
        <!--<echo message="Resetting ${db.name}, ${db.name}olap and ${db.name}tenant"/>-->

        <echo message="Loading tables list"/>
        <sql driver="${db.driver}" url="${db.url}" userid="${db.user}"
             password="${db.password}" expandproperties="true" output="${tmp.file}" print="true">
            <classpath>
                <fileset dir="${ofbiz.path}/framework/entity/lib/jdbc" includes="*.jar"/>
            </classpath>
            select 'drop table "' || tablename || '" cascade;'
            from pg_tables where schemaname = 'public';
        </sql>
        <!--where schemaname = '${db.name}';-->
        <replace file="${tmp.file}"
                 token="?column?" value=""/>
        <replace file="${tmp.file}"
                 token="0 rows affected" value="" casesensitive="false"/>

        <echo message="Dropping tables"/>
        <sql driver="${db.driver}" url="${db.url}" userid="${db.user}"
             password="${db.password}" expandproperties="true" print="false" src="${tmp.file}"
             autocommit="true">
            <classpath>
                <fileset dir="${ofbiz.path}/framework/entity/lib/jdbc" includes="*.jar"/>
            </classpath>

        </sql>
        <delete file="${tmp.file}"/>
    </target>

    <target name="clean-and-rebuild-postgresql-db" description="Drop all tables" depends="clean-postgresql-db">
        <subant target="clean-data" buildpath="${ofbiz.path}" antfile="build.xml"/>
        <subant target="run-install-seed" buildpath="${ofbiz.path}" antfile="build.xml"/>
    </target>

    <target name="clean-and-rebuild-postgresql-db-unit-test" description="Drop all tables"
            depends="clean-postgresql-db">
        <subant target="clean-data" buildpath="${ofbiz.path}" antfile="build.xml"/>
        <!--  <subant target="run-install-seed" buildpath="${ofbiz.path}" antfile="build.xml"/>
          <subant target="run-install-seed-init-data" buildpath="${ofbiz.path}/hot-deploy/gn" antfile="run-install.xml"/>
          <subant target="run-install-poc" buildpath="${ofbiz.path}/hot-deploy/gn" antfile="run-install.xml"/>
          <subant target="run-install-test" buildpath="${ofbiz.path}/hot-deploy/gn" antfile="run-install.xml"/>-->
        <subant target="run-install-readers" buildpath="${ofbiz.path}" antfile="build.xml">
            <property name="data-readers" value="seed,propeties,seed-init-data,test-data,poc-data"/>
        </subant>
        <!--<subant target="run-install-beta-test" buildpath="${ofbiz.path}" antfile="build.xml"/>-->
    </target>

    <target name="drop-postgresql-db" description="Drop all tables">
        <sql driver="${db.driver}" url="${db.url}" userid="${db.user}"
             password="${db.password}" expandproperties="true" output="${tmp.file}" print="true" autocommit="true">
            <classpath>
                <fileset dir="${ofbiz.path}/framework/entity/lib/jdbc" includes="*.jar"/>
            </classpath>
            DROP DATABASE ofbiz;
            CREATE DATABASE ofbiz;
        </sql>

    </target>

    <!--
        example found on internet
        <target name="clean-postgresql_old" description="Drop and recreate dbs">
            <property file="java.local.properties"/>
            <property file="${user.home}/java.local.properties"/>
            <property name="db.name" value="ofbiz"/>
            <property name="db.driver" value="${local.db.driver}"/>
            <property name="db.host" value="${local.db.host}"/>
            <property name="db.password" value="${local.db.password}"/>
            <property name="db.user" value="${local.db.user}"/>
            <fail message="No postgresql driver, not cleaning postgresql db">
                <condition>
                    <not>
                        <available type="file" file="${local.db.driverjar}" filepath="framework/entity/lib/jdbc/"/>
                    </not>
                </condition>
            </fail>
            <echo message="Resetting ${db.name}, ${db.name}olap and ${db.name}tenant"/>
            <sql driver="${db.driver}" url="jdbc:postgresql://${db.host}/${db.name}" userid="${db.user}" password="${db.password}" expandproperties="true">
                <classpath>
                    <fileset dir="framework/entity/lib/jdbc" includes="*.jar"/>
                </classpath>
                DROP SCHEMA public CASCADE;
                CREATE SCHEMA public AUTHORIZATION ofbiz;
                SCHEMA SET TABLESPACE ofbiz;
                GRANT ALL ON SCHEMA public TO ofbiz;
                GRANT ALL ON SCHEMA public TO public;
            </sql>
            <sql driver="${db.driver}" url="jdbc:postgresql://${db.host}/${db.name}olap" userid="${db.user}" password="${db.password}" expandproperties="true">
                <classpath>
                    <fileset dir="framework/entity/lib/jdbc" includes="*.jar"/>
                </classpath>
                DROP SCHEMA public CASCADE;
                CREATE SCHEMA public AUTHORIZATION ofbiz;
                GRANT ALL ON SCHEMA public TO ofbiz;
                GRANT ALL ON SCHEMA public TO public;
            </sql>
            <sql driver="${db.driver}" url="jdbc:postgresql://${db.host}/${db.name}tenant" userid="${db.user}" password="${db.password}" expandproperties="true">
                <classpath>
                    <fileset dir="framework/entity/lib/jdbc" includes="*.jar"/>
                </classpath>
                DROP SCHEMA public CASCADE;
                CREATE SCHEMA public AUTHORIZATION ofbiz;
                GRANT ALL ON SCHEMA public TO ofbiz;
                GRANT ALL ON SCHEMA public TO public;
            </sql>
        </target>
    -->


</project>
